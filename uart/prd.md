UART IP 产品需求文档（PRD）

1. 产品概述

该 IP 模块是一个支持 APB 总线接口 的 UART 外设，具备 标准 TX/RX 接口、中断机制、可配置 FIFO。目标是为 SoC 提供一个易于集成、低功耗、参数化的 UART 通信模块。

⸻

2. 系统接口

2.1 APB 接口
	•	信号：PCLK, PRESETn, PADDR, PWDATA, PRDATA, PWRITE, PSEL, PENABLE, PREADY, PSLVERR
	•	数据位宽：32-bit
	•	地址对齐：字对齐

2.2 UART 接口
	•	TXD：串行发送输出
	•	RXD：串行接收输入

2.3 中断接口
	•	IRQ：输出中断信号，可连接至系统中断控制器

⸻

3. 功能需求

3.1 基本通信特性
	•	波特率：1200bps ~ 1Mbps（可配置分频器）
	•	数据位：7/8 位可选
	•	停止位：1/2 位可选
	•	奇偶校验：无/奇/偶
	•	全双工收发

3.2 FIFO
	•	可配置深度：8/16/32 字节
	•	发送 FIFO：当非空时自动发送，直到为空
	•	接收 FIFO：接收数据缓存，溢出时产生错误标志

3.3 中断机制
	•	接收中断：RX FIFO 非空
	•	发送中断：TX FIFO 空
	•	错误中断：帧错误、奇偶校验错误、溢出错误
	•	中断控制：可屏蔽、可通过寄存器配置

3.4 错误检测
	•	帧错误：停止位不符合协议
	•	奇偶校验错误：接收数据与校验位不符
	•	溢出错误：接收 FIFO 满时仍有数据进入

⸻

4. 异步输入可靠性设计

UART 的 RXD 输入与系统时钟异步，必须保证可靠接收：
	1.	双触发器同步：RXD 首先进入两级 DFF，同步到本地时钟，降低亚稳态风险。
	2.	过采样（通常 16× 波特率）：在一个比特周期内采样多次，利用中点或多数投票法判定。
	3.	起始位检测与对齐：检测到低电平起始位后，以中点采样为基准对齐整个比特流。
	4.	错误检测机制：帧错误、奇偶校验错误、FIFO 溢出，均有寄存器标志和中断提示。
	5.	时钟偏差容忍度：支持 ±2% ~ ±5% 的时钟误差。
	6.	FIFO 缓冲：平滑抖动和突发数据，增强系统容错能力。

⸻

5. 寄存器映射与位域（Rev.1.0）

约定：R/W=可读写，RO=只读，WO=只写，W1C=写1清零；复位值为同步复位、低电平有效 PRESETn 后的值。

5.1 地址映射

偏移	名称	访问	复位	描述
0x00	DATA	R/W	0x0000_0000	收/发数据窗口（读：弹出RX FIFO；写：推进TX FIFO）
0x04	STATUS	RO	0x0000_0080	即时状态标志（满/空/忙/错误）
0x08	CTRL	R/W	0x0000_0001	全局控制（使能、位宽、校验、停止位等）
0x0C	BAUD	R/W	0x0000_0000	波特率分频（整数+小数）
0x10	FIFO_CTRL	R/W	0x0000_0000	FIFO控制与水位阈值
0x14	INT_STATUS	R/W1C	0x0000_0000	中断状态（写1清）
0x18	INT_ENABLE	R/W	0x0000_0000	中断使能
0x1C	INT_CLEAR	WO	0x0000_0000	中断显式清除（写1清，等价于对 INT_STATUS 写1）
0x20	FIFO_LEVEL	RO	0x0000_0000	RX/TX FIFO 实时深度
0x24	VERSION	RO	0xYYYY_MMDD	版本/构建信息（参数化生成）

说明：STATUS 复位值中的 TX_EMPTY=1（示意0x80）表示空闲；实际复位值可按实现调整，但语义保持一致。

⸻

5.2 DATA @0x00 (R/W)

位段	名称	访问	复位	描述
[7:0]	DATA	R/W	0x00	读：从 RX FIFO 弹出一个字节；写：向 TX FIFO 推入一个字节。
[15:8]	RSV	—	0	保留，读零。
[31:16]	EXT	R/W	0	预留扩展（可用于9-bit模式/地址位，当前实现读零写忽略）。

副作用：
	•	读寄存器且 RX_EMPTY=0 时，RX_LEVEL 减1；若为空则返回上次值且不改变状态（可选实现：返回0x00）。
	•	写寄存器且 TX_FULL=0 时，TX_LEVEL 加1并启动发送；若满则忽略写入，并在 STATUS.TX_WERR 置位（可选）。

⸻

5.3 STATUS @0x04 (RO)

位	名称	复位	描述
0	RX_NONEMPTY	0	RX FIFO 非空指示（RX_LEVEL>0）。
1	RX_FULL	0	RX FIFO 满。
2	TX_EMPTY	1	TX FIFO 空。
3	TX_FULL	0	TX FIFO 满。
4	RX_BUSY	0	接收器忙（采样/组帧中）。
5	TX_BUSY	0	发送器忙（移位中）。
6	ERR_ANY	0	任一错误产生（PE/FE/OE）。
7	IDLE	1	收发均空闲（无进行中帧且TX空）。
8	FE	0	帧错误（停止位非高）。
9	PE	0	奇偶校验错误。
10	OE	0	溢出错误 时序需求

	•	APB 时钟频率：最高 50 MHz
	•	UART 采样时钟：由波特率分频器生成
	•	异步通信：通过同步器 + 过采样机制实现稳定接收

⸻

（以下章节编号顺延不变）
–––––|–––––|——|
| 0x00 | DATA | 收发数据寄存器（读：接收数据，写：发送数据） |
| 0x04 | STATUS | 状态寄存器（TX空、RX非空、错误标志） |
| 0x08 | CTRL | 控制寄存器（启用、奇偶校验、数据位数、中断使能） |
| 0x0C | BAUD | 波特率配置寄存器（分频值） |
| 0x10 | FIFO_CTRL | FIFO 配置和清空控制 |
| 0x14 | INT_STATUS | 中断状态寄存器 |
| 0x18 | INT_CLEAR | 中断清除寄存器 |

⸻

6. 时序需求
	•	APB 时钟频率：最高 50 MHz
	•	UART 采样时钟：由波特率分频器生成
	•	异步通信：通过同步器 + 过采样机制实现稳定接收

⸻

7. 功耗与面积目标
	•	面积：28nm 工艺下 < 0.01 mm²
	•	功耗：工作模式 < 50 µW，空闲时自动门控时钟

⸻

8. 设计可配置参数
	•	FIFO 深度（8/16/32）
	•	数据位宽（7/8）
	•	波特率范围
	•	校验模式（None/Even/Odd）

⸻

9. 异常处理
	•	接收 FIFO 溢出：丢弃最新数据，置位溢出标志
	•	帧错误/奇偶错误：记录在 STATUS 寄存器，触发中断（可选）
	•	写 TX FIFO 满：忽略写入请求

⸻

10. 验证需求
	•	仿真用例：
	•	正常收发
	•	波特率边界值（最低速/最高速）
	•	FIFO 溢出情况
	•	奇偶校验错误注入
	•	连续发送/接收压力测试

⸻

11. 交付物
	•	RTL 代码（Verilog/SystemVerilog）
	•	配套文档（用户手册、寄存器定义）
	•	仿真测试环境（testbench）
	•	示例驱动代码（C/firmware）
# UART IP 产品需求文档（PRD）

版本：v1.0  
日期：2025-09-18

---

## 1. 产品概述
该 UART IP 为 SoC/MCU 提供标准的异步串行通信能力，采用 **APB** 作为寄存器编程总线，提供 **TXD/RXD** 标准接口与 **IRQ** 中断输出。设计目标：**易集成**、**高可靠**、**低面积/低功耗**、**高度参数化**。

---

## 2. 系统接口（Signal List）
> 约定：输入=I，输出=O，低有效后缀 `n`；无特别说明电平为高有效。

### 2.1 时钟与复位
| 信号 | Dir | 宽度 | 描述 |
|---|---|---|---|
| PCLK | I | 1 | APB/工作时钟，最高 50 MHz（默认）。 |
| PRESETn | I | 1 | 异步低有效复位，释放后同步到 `PCLK`。 |

### 2.2 APB 接口（32-bit）
| 信号 | Dir | 宽度 | 描述 |
|---|---|---|---|
| PSEL | I | 1 | 片选。 |
| PENABLE | I | 1 | 传输阶段指示。 |
| PWRITE | I | 1 | 1=写，0=读。 |
| PADDR | I | `APB_ADDR_WIDTH` | 地址（**字对齐**）。默认 6 位（覆盖 0x00~0x3F）。 |
| PWDATA | I | 32 | 写数据。 |
| PRDATA | O | 32 | 读数据。 |
| PREADY | O | 1 | 就绪；默认 **0 wait**（始终 1），可参数化插入等待。 |
| PSLVERR | O | 1 | 错误响应（保留，默认 0）。 |

### 2.3 UART 引脚
| 信号 | Dir | 宽度 | 描述 |
|---|---|---|---|
| TXD | O | 1 | 串行发送输出。空闲为高。 |
| RXD | I | 1 | 串行接收输入。 |
| RTS (可选) | O | 1 | 请求发送（流控），极性可配（默认不实例化）。 |
| CTS (可选) | I | 1 | 允许发送（流控），极性可配（默认不实例化）。 |

### 2.4 中断
| 信号 | Dir | 描述 |
|---|---|---|
| IRQ | O | 中断输出，电平有效（至少一个已使能的中断挂起）。 |

---

## 3. 功能特性
- 波特率范围：1.2 kbps ~ 1 Mbps（更高速率取决于 `PCLK` 与分频设定）。
- 数据位：7/8 位；停止位：1/2；校验：无/奇/偶。
- **异步输入可靠性**：双级同步器 + 可选三级；默认 **×16 过采样**（支持 ×8/×4）；起始位中点对齐；可选多数投票。
- FIFO：独立 RX/TX FIFO，深度参数化（典型 8/16/32 字节）。
- 中断：RX 阈值、TX 阈值/空、接收超时、帧错、奇偶错、溢出、收发完成。
- 低功耗：门控时钟；`UART_EN=0` 时进入低功耗（保持寄存器/FIFO 语义可选）。

---

## 4. 参数化配置（Generics）
| 参数 | 缺省 | 说明 |
|---|---|---|
| APB_ADDR_WIDTH | 6 | APB 地址宽度（字对齐）。 |
| FIFO_DEPTH | 16 | RX/TX FIFO 深度（8/16/32）。只读暴露于寄存器。 |
| DEFAULT_OSR | 16 | 过采样倍率默认值（4/8/16）。 |
| FRACTIONAL_BAUD | 1 | 1=启用 1/256 小数分频。 |
| HAS_RTS_CTS | 0 | 1=实例化流控。 |
| SYNC_STAGES | 2 | RXD 同步级数。 |

---

## 5. 异步输入的可靠性设计（RX 侧）
1) **同步器**：`RXD` → 两级（可配三级）D 触发器同步到 `PCLK`，降低亚稳态传播概率。  
2) **过采样**：内部波特率时钟 = `PCLK / (OSR * DIV)`；在每比特周期取 `OSR` 次采样（默认 16 次）。  
3) **起始位检测**：检测到下降沿后，延迟半个比特周期在 **中点**二次确认，再按整比特周期采样后续位。  
4) **判决策略**：中点采样或 3/5 多数投票（实现可选）；停止位为高判定正确。  
5) **误差容忍**：设计保证两端时钟 **±2%~±5%** 偏差内稳健解码（取决于 OSR/采样策略）。  
6) **错误与恢复**：停止位为低→`FE`；奇偶不符→`PE`；RX FIFO 满仍入字节→`OE`；错误均可产生中断并通过寄存器清除。  

> 文本流程（RX）：`RXD_sync` ↓start→(半比特)→中点确认→按位采样×N（7/8）→可选奇偶→停止位→入 FIFO/置错。

---

## 6. 寄存器映射与位域（Rev.1.0）
> 访问权限：`R/W`=可读写，`RO`=只读，`WO`=只写，`R/W1C`=读写，写 1 清零。复位为 `PRESETn` 释放后同步值。

### 6.1 地址映射
| 偏移 | 名称 | 访问 | 复位 | 描述 |
|---|---|---|---|---|
| 0x00 | DATA | R/W | 0x0000_0000 | 收/发数据窗口（读：弹出 RX；写：推进 TX）。 |
| 0x04 | STATUS | RO | 0x0000_0084 | 即时状态（含 TX 空 & IDLE）。 |
| 0x08 | CTRL | R/W | 0x0000_0007 | 使能/格式/过采样等控制。 |
| 0x0C | BAUD | R/W | 0x0000_0000 | 波特率分频（整数+小数）。 |
| 0x10 | FIFO_CTRL | R/W | 0x0000_0000 | FIFO 清空、阈值、超时。 |
| 0x14 | INT_STATUS | R/W1C | 0x0000_0000 | 中断状态（写 1 清）。 |
| 0x18 | INT_ENABLE | R/W | 0x0000_0000 | 中断使能。 |
| 0x1C | INT_CLEAR | WO | 0x0000_0000 | 中断显式清除（写 1 清）。 |
| 0x20 | FIFO_LEVEL | RO | 0x0000_0000 | RX/TX FIFO 即时深度。 |
| 0x24 | VERSION | RO | 0x0100_2509 | 版本/日期（示例 v1.0/2025-09-25）。 |

> 注：`STATUS` 复位值中设置 `TX_EMPTY=1` 与 `IDLE=1` 便于上电状态可见。

### 6.2 DATA @0x00 (R/W)
| 位段 | 名称 | 访问 | 复位 | 描述 |
|---|---|---|---|---|
| [7:0] | DATA | R/W | 0x00 | 读：从 RX FIFO 弹出 1 字节；写：向 TX FIFO 推入 1 字节。 |
| [15:8] | RSV | — | 0 | 保留，读 0。 |
| [31:16] | EXT | R/W | 0 | 预留扩展（9bit/地址位；当前读 0 写忽略）。 |

> 副作用：读 DATA 且 `RX_LEVEL>0` 时 `RX_LEVEL--`；写 DATA 且 `!TX_FULL` 时 `TX_LEVEL++` 并触发发送。

### 6.3 STATUS @0x04 (RO)
| 位 | 名称 | 复位 | 描述 |
|---|---|---|---|
| 0 | RX_NONEMPTY | 0 | `RX_LEVEL>0`。 |
| 1 | RX_FULL | 0 | RX FIFO 满。 |
| 2 | TX_EMPTY | 1 | TX FIFO 空。 |
| 3 | TX_FULL | 0 | TX FIFO 满。 |
| 4 | RX_BUSY | 0 | 接收器正在采样/组帧。 |
| 5 | TX_BUSY | 0 | 发送器正在移位。 |
| 6 | ERR_ANY | 0 | `FE`/`PE`/`OE` 任一为 1。 |
| 7 | IDLE | 1 | 无收发活动且 TX 空。 |
| 8 | FE | 0 | 帧错误。 |
| 9 | PE | 0 | 奇偶错误。 |
| 10 | OE | 0 | 溢出错误。 |
| 11 | TX_WERR | 0 | TX 满时写 DATA（可选实现）。 |
| [31:12] | RSV | 0 | 保留。 |

### 6.4 CTRL @0x08 (R/W)
| 位 | 名称 | 复位 | 描述 |
|---|---|---|---|
| 0 | UART_EN | 1 | 全局使能；0=低功耗（可选清 FIFO）。 |
| 1 | RX_EN | 1 | 使能接收路径。 |
| 2 | TX_EN | 1 | 使能发送路径。 |
| 3 | LOOPBACK_EN | 0 | 内部回环（用于自测）。 |
| 5:4 | DATA_LEN | 0 | 00=8 位，01=7 位；其他保留。 |
| 6 | PARITY_EN | 0 | 1=使能奇偶校验。 |
| 7 | PARITY_ODD | 0 | 1=奇，0=偶（当 `PARITY_EN=1` 有效）。 |
| 8 | STOP_2 | 0 | 0=1 停止位，1=2 停止位。 |
| 13:10 | OSR_SEL | 0 | 0=×16，1=×8，2=×4；其余保留。 |
| [31:14] | RSV | 0 | 保留/扩展。 |

### 6.5 BAUD @0x0C (R/W)
| 位段 | 名称 | 复位 | 描述 |
|---|---|---|---|
| [15:0] | DIV_INT | 0x0000 | 整数分频。 |
| [23:16] | DIV_FRAC | 0x00 | 小数分频，步进 1/256。 |
| [31:24] | RSV | 0 | 保留。 |

计算：**Baud = PCLK / (OSR × (DIV_INT + DIV_FRAC/256))**  
示例：`PCLK=50MHz, OSR=16, 目标 115200` → `DIV≈27.1267` → `DIV_INT=27, DIV_FRAC≈32`。

### 6.6 FIFO_CTRL @0x10 (R/W)
| 位段 | 名称 | 复位 | 描述 |
|---|---|---|---|
| 0 | RX_CLR | 0 | 写 1 清空 RX FIFO（自清 0）。 |
| 1 | TX_CLR | 0 | 写 1 清空 TX FIFO（自清 0）。 |
| 5:2 | RX_TRIG | 0 | RX 阈值（字节），用于 `RX_TRIG_INT`。 |
| 9:6 | TX_TRIG | 0 | TX 阈值（字节/剩余空间），用于 `TX_TRIG_INT`。 |
| 13:10 | TIMEOUT_CFG | 0 | 接收超时门限（按字符时间）。 |
| 15:14 | RSV | 0 | 保留。 |
| 23:16 | FIFO_DEPTH | N | 只读：实例化深度（8/16/32）。 |
| [31:24] | RSV2 | 0 | 保留。 |

### 6.7 INT_STATUS @0x14 (R/W1C) / INT_ENABLE @0x18 (R/W) / INT_CLEAR @0x1C (WO)
| 位 | 名称 | 描述 |
|---|---|---|
| 0 | RX_TRIG_INT | `RX_LEVEL ≥ RX_TRIG` 产生。 |
| 1 | TX_TRIG_INT | `TX_EMPTY` 或 `TX_LEVEL ≤ TX_TRIG` 产生。 |
| 2 | RX_TIMEOUT_INT | 接收超时产生。 |
| 3 | FE_INT | 帧错误。 |
| 4 | PE_INT | 奇偶错误。 |
| 5 | OE_INT | 溢出错误。 |
| 6 | RX_DONE_INT | 一帧接收完成（停止位确认）。 |
| 7 | TX_DONE_INT | 一帧发送完成（移位器空）。 |
| [31:8] | RSV | 保留。 |

规则：对 `INT_STATUS` 写 1 清相应位；`INT_CLEAR` 写 1 的效果等价于对 `INT_STATUS` 写 1。`INT_ENABLE` 为掩码。  
`IRQ = any(INT_STATUS[i] & INT_ENABLE[i])`。

### 6.8 FIFO_LEVEL @0x20 (RO)
| 位段 | 名称 | 描述 |
|---|---|---|
| [7:0] | RX_LEVEL | RX FIFO 字节数。 |
| [15:8] | TX_LEVEL | TX FIFO 字节数。 |
| [31:16] | RSV | 保留。 |

### 6.9 VERSION @0x24 (RO)
建议编码：`[31:16]=版本`，`[15:0]=日期`（例如 `0x0100_2509` 表示 v1.0 / 2025-09-25）。

---

## 7. 复位与边界条件
- 复位后：`TXD=1`（空闲高），`STATUS.TX_EMPTY=1`，`STATUS.IDLE=1`，FIFO 清空。  
- 当 `RX_FULL=1` 且仍有新字节：置位 `OE`，丢弃**最新**字节（或可选：丢弃最旧，须在文档与 RTL 中一致）。  
- `LOOPBACK_EN=1`：TX 路径数据回注 RX 前端（仍走过采样/校验）。

---

## 8. 时序/性能
- `PCLK` ≤ 50 MHz（可随工艺/需求上调）。  
- 建议综合目标频率 ≥ 0.9× `PCLK`。  
- 采样时钟来自分频器；保证在 OSR=16 下 ±2%~±5% 时钟偏差可稳定通信。

---

## 9. 验证需求（最小场景）
1) 波特率角落：最低/最高/中间值；跨时钟误差 ±5%。  
2) 帧错误/奇偶错误/溢出注入与中断联动。  
3) RX/TX FIFO 阈值/清空/水位计数一致性。  
4) 回环自测：随机帧序列一致性。  
5) APB 读写一致性/零等待；非法地址访问不破坏状态。  
6) 超时中断在空闲线（高电平）下行为正确。

---

## 10. 交付物
- RTL（SystemVerilog/Verilog）与参数包；  
- Testbench + 常用测试序列与覆盖率报告；  
- 约束文件（SDC）与综合脚本示例；  
- 驱动示例（C）：初始化、收发、中断服务程序模板；  
- 使用手册（含寄存器与编程示例）。

---

## 附录 A：快速编程示例
```c
// 1) 复位后初始化：115200@50MHz、8N1、OSR=16
write32(BAUD, (27) | (32<<16));        // DIV_INT=27, DIV_FRAC=32
write32(CTRL, BIT(UART_EN)|BIT(RX_EN)|BIT(TX_EN));
write32(FIFO_CTRL, (4<<2) | (2<<6));    // RX_TRIG=4B, TX_TRIG=2B
write32(INT_ENABLE, BIT(0)|BIT(1)|BIT(2)); // 使能 RX阈值/TX阈值/超时

// 2) 发送 1 字节（轮询）
while (!(read32(STATUS) & BIT(TX_EMPTY))) {}
write32(DATA, 0x55);

// 3) 接收（中断服务例程）
if (read32(INT_STATUS) & BIT(0)) { // RX_TRIG_INT
  while (read32(FIFO_LEVEL) & 0xFF) {
    uint8_t b = read32(DATA) & 0xFF;
    consume(b);
  }
  write32(INT_STATUS, BIT(0)); // W1C
}
```